---
title: 'Garbage Collector в Go'
description: 'Как работает автоматическое управление памятью в Go: трехцветная маркировка, фазы GC и Write Barrier.'
category: 'Golang'
date: '2026-02-02'
---

**Garbage Collection (GC)** — это автоматизированный процесс управления памятью, который освобождает неиспользуемые объекты, предотвращая утечки и оптимизируя ресурсы.

## Как работает GC в Go?

Go использует **конкурентный (concurrent) Mark-and-Sweep сборщик мусора**. Его ключевая особенность — минимизация пауз "Stop-the-World" (STW). Большая часть работы выполняется параллельно с выполнением кода программы.

### Алгоритм: Трёхцветная маркировка

GC использует абстракцию трех цветов для отслеживания состояния объектов:

1. **Белые**: Потенциальный мусор. Изначально все объекты белые. В конце цикла все оставшиеся белыми объекты удаляются.
2. **Серые**: Очередь на обработку. Объекты, которые найдены (достижимы), но их содержимое (ссылки) еще не просканировано.
3. **Чёрные**: Гарантированно живые объекты, сканирование которых завершено.

### Фазы работы

1. **Mark Setup (Подготовка)**:
    * Короткая пауза (STW).
    * Включается **Write Barrier**.
2. **Marking (Пометка)**:
    * Основная фаза, работает **параллельно** с программой (конкурентно).
    * GC сканирует корневые объекты (стек, глобальные переменные) и перемещает их в серые, затем рекурсивно проходит по ссылкам, окрашивая всё в чёрный.
3. **Mark Termination (Завершение)**:
    * Короткая пауза (STW).
    * Завершение обработки очереди серых объектов и отключение Write Barrier.
4. **Sweep (Очистка)**:
    * Работает **параллельно** (конкурентно).
    * Память, занятая белыми объектами, возвращается в систему.

## Write Barrier (Барьер записи)

Так как программа (мутатор) продолжает работать во время сканирования, она может изменять указатели. Без защиты это могло бы привести к удалению живого объекта (например, если программа переместит ссылку на белый объект внутрь уже проверенного чёрного объекта).

**Write Barrier** — это микро-инструкция, выполняемая при каждой записи указателя в память во время фазы Marking.

* **Принцип**: "При записи указателя, закрась объект серым".
* **Результат**: Гарантирует, что ни один живой объект не останется белым к концу маркировки (соблюдение "триколор инварианта").
* **Цена**: Небольшие накладные расходы на CPU при записи указателей, но только во время работы GC.

## Настройка (GOGC)

Переменная `GOGC` (по умолчанию `100`) управляет частотой запуска GC.
Она задает целевой процент прироста кучи. `GOGC=100` означает: "Запустить сборку, когда объем новой памяти станет равен объему живых данных после прошлой сборки" (рост на 100%).

## Заключение

Garbage Collection в Go — это высокопроизводительный механизм, балансирующий между задержками и утилизацией ресурсов. Понимание его работы (особенно стоимости Write Barrier и аллокаций) помогает писать более эффективный код в HighLoad системах.

## Полезные ссылки

* <https://habr.com/ru/companies/avito/articles/753244/>
* <https://www.youtube.com/watch?v=ZZJBu2o-NBU>
